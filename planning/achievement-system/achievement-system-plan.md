
# 実績システム計画書

## 1. はじめに

本ドキュメントは、「Cosmic Gardener」における実績システムの導入に関する計画を定義するものである。

### 1.1. 目的

実績システムは、以下の目的のために導入する。

-   **プレイヤーエンゲージメントの向上**: プレイヤーに短期・中期的な目標を提供し、継続的なプレイを促進する。
-   **ゲームプレイの多様化**: 特定のプレイスタイルや行動を評価することで、プレイヤーに新しい遊び方を提示する。
-   **達成感の提供**: ゲーム内でのプレイヤーの努力と進捗を可視化し、達成感と満足感を与える。
-   **チュートリアルとしての役割**: ゲーム序盤の実績を通じて、プレイヤーに自然な形でゲームの基本操作やシステムを学習させる。

## 2. 機能要件

### 2.1. 実績カテゴリ

実績は、プレイヤーがゲームのどの側面で進捗を遂げたかを分かりやすくするため、以下のカテゴリに分類する。

-   **生産**: 特定の資源の生産量や保有量に関する実績。
-   **創造**: 天体や生命の創造に関する実績。
-   **探検**: ゲーム宇宙の特定の領域への到達や、特殊な現象の発見に関する実績。
-   **進化**: 生命が特定の段階へ進化した際の実績。
-   **技術**: 研究開発ツリーの特定のマイルストーン達成に関する実績。
-   **継続**: ログイン日数やプレイ時間など、継続的なプレイに関する実績。

### 2.2. 実績リスト（一部抜粋）

初期リリースで実装する実績の例を以下に示す。

| カテゴリ | 実績名                 | 達成条件                               | 報酬（案）   |
| :------- | :--------------------- | :------------------------------------- | :----------- |
| 生産     | はじめてのエネルギー   | エネルギーを初めて1kJ生産する          | 称号:「開拓者」|
| 生産     | ダークマターの発見     | ダークマターを初めて保有する           | アイコン     |
| 創造     | 小さな星の誕生         | 最初の恒星を創造する                   | 資源パック   |
| 創造     | 生命のゆりかご         | 居住可能な惑星を創造する               | -            |
| 進化     | 産声                   | 最初の微生物が誕生する                 | 称号:「生命の母」|
| 進化     | 知性の夜明け           | 知的生命体が誕生する                   | 限定スキン   |
| 技術     | 第二段階技術の解放     | 研究ツリーのティア2をアンロックする    | 資源パック   |
| 継続     | 宇宙の庭師             | 累計プレイ時間が10時間を超える         | -            |

### 2.3. UI/UX

-   **達成通知**:
    -   実績達成時、画面右下にトースト通知をアニメーション付きで表示する。
    -   通知には、実績名とアイコン、獲得した報酬が表示される。
    -   通知音も再生する。
-   **実績一覧画面**:
    -   メニューから実績一覧画面に遷移できる。
    -   カテゴリ別のタブで実績をフィルタリング可能。
    -   各実績には、アイコン、名称、説明、達成状況（達成済み/未達成）、達成日が表示される。
    -   未達成の実績には、達成条件のヒントが表示される。

## 3. 技術仕様

実績システムは、既存のバックエンド・フロントエンドのアーキテクチャに準拠して実装する。

### 3.1. データベース設計 (PostgreSQL)

新たに2つのテーブルを追加する。

**1. `achievements` (実績マスターテーブル)**

| カラム名        | 型                  | 説明                         |
| :-------------- | :------------------ | :--------------------------- |
| `id`            | `SERIAL PRIMARY KEY`| 実績ID                       |
| `category`      | `VARCHAR(50)`       | カテゴリ (production, creation) |
| `name`          | `VARCHAR(100)`      | 実績名                       |
| `description`   | `TEXT`              | 実績の説明文                 |
| `trigger_type`  | `VARCHAR(50)`       | 達成条件のトリガータイプ     |
| `trigger_value` | `JSONB`             | トリガーの具体的な条件値     |
| `icon_path`     | `VARCHAR(255)`      | アイコンのパス               |
| `reward_type`   | `VARCHAR(50)`       | 報酬の種類 (title, item)     |
| `reward_value`  | `JSONB`             | 報酬の具体的な内容           |

**2. `user_achievements` (ユーザー実績達成テーブル)**

| カラム名        | 型                  | 説明                             |
| :-------------- | :------------------ | :------------------------------- |
| `id`            | `SERIAL PRIMARY KEY`| 達成記録ID                       |
| `user_id`       | `INTEGER`           | ユーザーID (FK to `users.id`)    |
| `achievement_id`| `INTEGER`           | 実績ID (FK to `achievements.id`) |
| `achieved_at`   | `TIMESTAMP WITH TIME ZONE` | 達成日時                         |

### 3.2. バックエンド (Rust / Actix Web)

-   **実績判定ロジック**:
    -   `application/services` に `achievement_service.rs` を新設。
    -   各種ゲームイベント（資源更新、天体生成など）の発生時に、関連する実績の達成条件をチェックする。
    -   パフォーマンスへの影響を最小限に抑えるため、判定ロジックは非同期で実行する。
-   **WebSocket通信**:
    -   実績を達成した際、`AchievementUnlocked` メッセージを定義し、該当ユーザーのセッションにWebSocket経由でプッシュする。
-   **APIエンドポイント**:
    -   `GET /api/achievements`: ユーザーの全実績の達成状況リストを返すAPIを新設する。

### 3.3. フロントエンド (TypeScript / Three.js)

-   **状態管理**:
    -   実績の達成状況を管理するための状態（State）を追加する。
-   **WebSocketハンドラ**:
    -   `AchievementUnlocked` メッセージを受信し、実績達成通知UIをトリガーする。
-   **UIコンポーネント**:
    -   実績達成を通知するトーストコンポーネントを新規作成。
    -   実績一覧を表示するページ（モーダルウィンドウ or 専用画面）を新規作成。APIから取得したデータを表示する。

## 4. 開発計画

### 4.1. タスク分割

-   **フェーズ1: バックエンド実装** (見積もり: 5人日)
    -   [ ] DBマイグレーションファイルの作成 (テーブル定義)
    -   [ ] `achievements` テーブルへのマスターデータ投入スクリプト作成
    -   [ ] 実績判定サービスの基本ロジック実装
    -   [ ] 資源生産に関する実績判定ロジックの実装
    -   [ ] WebSocket通知機能の実装
    -   [ ] APIエンドポイントの実装とテスト
-   **フェーズ2: フロントエンド実装** (見積もり: 4人日)
    -   [ ] 実績一覧のAPI通信と状態管理ロジック実装
    -   [ ] 実績一覧UIコンポーネントの実装
    -   [ ] WebSocketメッセージ受信ハンドラの実装
    -   [ ] 実績達成通知UIコンポーネントの実装
-   **フェーズ3: 統合とテスト** (見積もり: 2人日)
    -   [ ] E2Eテストの作成
    -   [ ] パフォーマンステスト（実績判定ロジックの負荷測定）
    -   [ ] リファクタリングとドキュメント整備

### 4.2. マイルストーン

-   **マイルストーン1 (1週目)**: バックエンド実装完了。API経由で実績状況が取得でき、達成時にWebSocketで通知が飛ぶ状態になる。
-   **マイルストーン2 (2週目)**: フロントエンド実装完了。実績一覧の表示と、達成通知がUIに表示される状態になる。
-   **マイルストーン3 (2.5週目)**: テストと最終調整完了。リリース可能な状態になる。

## 5. 将来の展望

-   **実績の拡充**: 新機能の追加に合わせて、新しい実績を随時追加していく。
-   **ランキング機能**: 特定の実績の達成速度や達成数を競うランキングシステムを導入する。
-   **ソーシャル連携**: フレンドと実績の達成状況を比較したり、SNSで実績達成をシェアしたりする機能を追加する。
-   **隠し実績**: 特定の行動パターンでのみ達成できる「隠し実績」を導入し、探求の楽しみを提供する。 
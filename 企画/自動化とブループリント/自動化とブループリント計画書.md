# 自動化とブループリント計画書

## 1. はじめに

本ドキュメントは、「Cosmic Gardener」の中盤から終盤にかけてのゲームプレイを効率化し、大規模な宇宙創造を支援するための「自動化とブループリント」機能に関する計画を定義するものである。

### 1.1. 目的

本機能は、以下の目的のために導入する。

-   **操作負担の軽減**: 繰り返し行う定型的な操作（施設の建設、資源変換の設定など）を自動化し、プレイヤーのクリック数を削減する。
-   **大規模建設の支援**: 複数の施設や天体の配置パターンを「ブループリント」として保存・再利用可能にし、大規模な宇宙インフラの構築を容易にする。
-   **戦略性の向上**: 細かい手作業からプレイヤーを解放し、より高次の戦略（宇宙全体のレイアウト最適化、資源フローの管理など）に集中させる。
-   **プレイヤー間のノウハウ共有**: プレイヤーが作成したブループリントをエクスポート・インポートできるようにし、コミュニティ内での知識共有を促進する。

## 2. 機能要件

### 2.1. ブループリント機能

-   **作成**:
    -   プレイヤーは、ゲーム画面上で特定の範囲を選択し、その中にある建造物群や天体の配置、設定（変換レシピなど）を一つのブループリントとして保存できる。
-   **保存**:
    -   保存したブループリントには、名前と説明を付けてライブラリに保管できる。
    -   ライブラリには、ブループリントのプレビューと、建設に必要な総コストが表示される。
-   **配置**:
    -   ライブラリからブループリントを選択し、建設したい場所にゴーストとして配置できる。
    -   資源が足りていれば、クリック一つでブループリント内の全ての建造物が自動的に建設される。
-   **共有**:
    -   ブループリントは、ゲーム外のテキスト文字列としてエクスポートできる。
    -   他のプレイヤーがその文字列をインポートすることで、同じブループリントを利用できる。

### 2.2. 建設ドローン（自動化ユニット）

-   **機能**: ブループリントの建設を自動で行うユニット。
-   **運用**:
    -   プレイヤーは「ドローンハブ」を建設し、そこから建設ドローンを射出する。
    -   ブループリントを配置すると、ドローンが自動的に必要な資源をドローンハブから引き出し、建設現場まで輸送して建設を行う。
    -   これにより、「資源さえあれば即時完成」ではなく、視覚的にも楽しい建設プロセスが生まれる。

### 2.3. 自動化ルールの設定

-   **資源管理の自動化**:
    -   特定の資源が設定した閾値を下回った場合に、自動的に特定の変換レシピを実行する、といったルールを設定できる。
    -   例：「エネルギー備蓄が1000PJを下回ったら、ダークマターをエネルギーに変換する」
-   **自動建設**:
    -   特定の天体が創造されたら、自動的にその周りに指定したブループリント（例：衛星軌道上の発電所群）を配置する、といった高度なルールも設定可能にする。

## 3. 技術仕様

### 3.1. データ構造

**ブループリントのデータ形式 (JSON)**

```json
{
  "name": "高効率エネルギー生産クラスター",
  "description": "中性子星の周りに配置する発電所の基本形",
  "version": 1,
  "entities": [
    {
      "type": "building",
      "name": "EnergyCollector_Mk3",
      "position": { "x": 10.5, "y": -5.0, "z": 0.0 },
      "rotation": { "x": 0, "y": 0, "z": 90 },
      "settings": { "priority": "high" }
    },
    // ... 他のエンティティ
  ],
  "icons": ["energy", "production"]
}
```

-   ブループリントは、サーバー側ではユーザーデータとしてDBに保存するが、クライアント間の共有は上記のようなJSONをBase64エンコードした文字列で行う。

### 3.2. バックエンド (Rust / Actix Web)

-   **ブループリント管理**:
    -   ユーザーのブループリントライブラリを保存・管理するためのDBテーブル (`user_blueprints`) とAPIを実装する。
-   **建設ロジック**:
    -   ブループリント配置リクエストを受け取り、建設に必要なコスト計算と資源の引き落としを行う。
    -   建設ドローンのロジック（資源輸送、建設時間）をサーバーサイドで管理し、不正な即時建設を防ぐ。
-   **自動化ルールエンジン**:
    -   ユーザーが設定したルールを定期的に評価し、条件が満たされた場合にアクション（変換、建設など）を実行するサービスを実装する。

### 3.3. フロントエンド (TypeScript / Three.js)

-   **ブループリントUI**:
    -   範囲選択、保存、ライブラリ閲覧、配置といった一連の操作を行うためのUIモードを実装する。
-   **ゴースト表示**:
    -   配置前のブループリントを、半透明のゴーストとしてレンダリングする。建設可能かどうかに応じて色を変える（例：緑＝可能、赤＝不可）。
-   **ドローンの可視化**:
    -   建設ドローンが資源を運び、施設を組み立てていく様子を視覚的に表現する。

## 4. 開発計画

### 4.1. タスク分割

-   **フェーズ1: ブループリント基本機能（バックエンド）** (見積もり: 5人日)
    -   [ ] ブループリントのデータ構造設計と管理API実装
    -   [ ] ブループリント配置時のコスト計算と建設ロジック実装
    -   [ ] 文字列でのインポート/エクスポート機能
-   **フェーズ2: ブループリント基本機能（フロントエンド）** (見積もり: 6人日)
    -   [ ] 範囲選択とブループリント作成UI
    -   [ ] ライブラリUIと配置UI（ゴースト表示含む）
-   **フェーズ3: 建設ドローンと自動化ルール** (見積もり: 7人日)
    -   [ ] 建設ドローンのロジックと3Dモデル/アニメーション実装
    -   [ ] 自動化ルールを設定するためのUI実装
    -   [ ] サーバーサイドでのルール評価エンジンの実装
-   **フェーズ4: 統合とテスト** (見積もり: 3人日)
    -   [ ] 全機能のE2Eテスト
    -   [ ] パフォーマンスチューニングとバグ修正

### 4.2. マイルストーン

-   **マイルストーン1 (1週目)**: バックエンド実装完了。API経由でブループリントの保存と配置が可能になる。
-   **マイルストーン2 (2.5週目)**: フロントエンド実装完了。UIからブループリントを作成・配置できる。
-   **マイルストーン3 (4週目)**: ドローンと自動化ルール実装完了。一通りの機能が利用可能になる。

## 5. 将来の展望

-   **中央管制システム**: 宇宙全体の資源フローや生産状況を一覧し、高度な自動化ルールを設定できる専用の管理画面。
-   **ブループリントの格付け**: コミュニティで共有されたブループリントを他のプレイヤーが評価・レビューできるシステム。
-   **条件付きブループリント**: 「周囲にX個のYがあったら、このブループリントを配置する」といった、より高度な論理をブループリント自体に組み込めるようにする。 
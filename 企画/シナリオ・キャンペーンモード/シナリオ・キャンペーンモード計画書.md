# シナリオ・キャンペーンモード計画書

## 1. はじめに

本ドキュメントは、「Cosmic Gardener」にシングルプレイ体験を深化させる「シナリオ・キャンペーンモード」の導入に関する計画を定義するものである。

### 1.1. 目的

本モードは、以下の目的のために導入する。

-   **物語性の提供**: プレイヤーに明確な物語と目的を提供し、ゲームへの没入感を高める。
-   **ゲームプレイの誘導**: プレイヤーを特定の目標達成に導くことで、ゲームの各要素を段階的に学べるようにする。
-   **リプレイ性の向上**: 異なる初期条件や目標を持つ複数のシナリオを提供し、繰り返しプレイする動機付けを与える。
-   **達成感の強化**: サンドボックスモードとは異なる、明確なクリア条件とエンディングを用意することで、大きな達成感を提供する。

## 2. 機能要件

### 2.1. シナリオ構造

-   各シナリオは、独自の「背景ストーリー」「初期状態」「勝利条件」「敗北条件」を持つ。
-   キャンペーンは、複数のシナリオが連なった形式で、前のシナリオをクリアすると次のシナリオが解放される。
-   リリース時には、3～5つのシナリオからなるチュートリアルキャンペーンを1つ提供する。

### 2.2. シナリオ例

| シナリオ名 | 背景ストーリー | 初期状態 | 勝利条件 | 敗北条件 | 特殊ルール |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **失われた故郷** | 古代文明の末裔として、かつての故郷の星系を再生する旅に出る。 | 限られた資源と初期技術のみ。特定の星系の座標が与えられる。 | 1. 目標の星系に到達する。<br>2. 居住可能な惑星を3つ創造する。<br>3. 特定の「遺産」建造物を建設する。 | 100サイクル以内に勝利条件を達成できない。 | 資源生成ペナルティ(-20%)。 |
| **宇宙の疫病** | 自己増殖するナノマシンの疫病「グレイグー」が宇宙を蝕んでいる。それを食い止める研究を行う。 | 高度な研究施設を持つが、資源は乏しい。グレイグー汚染エリアが隣接している。 | 1. 「グレイグー無力化技術」を研究・開発する。<br>2. 汚染源となっている天体を浄化する。 | 自らの母星がグレイグーに完全に侵食される。 | グレイグーは時間経過で拡大する。 |
| **神への挑戦** | 宇宙の創造主を自称する超知性体から挑戦を受ける。指定された条件下で宇宙を創造し、その能力を証明する。 | 無限の資源。ただし、使用できる天体の種類や技術に制限がある。 | 1. 100サイクル以内に指定された「美しさスコア」を超える宇宙を創造する。<br>2. 指定された5種類の生命体を進化させる。 | スコアが基準に満たない。 | 特定の資源が使用不可。 |

### 2.3. UI/UX

-   **シナリオ選択画面**:
    -   メインメニューに「キャンペーン」モードを追加。
    -   選択可能なシナリオがカード形式で表示され、背景ストーリー、勝利/敗北条件、予想難易度を確認できる。
-   **ゲーム中のUI**:
    -   画面の隅に現在のシナリオ目標と進捗状況を常に表示する。
    -   ストーリーに関連するイベントが発生した際に、専用のダイアログボックスでテキストを表示する。
-   **リザルト画面**:
    -   シナリオクリアまたは失敗時に、リザルト画面を表示。
    -   クリアタイム、達成スコア、各種統計情報を表示し、プレイヤーのパフォーマンスを評価する。

## 3. 技術仕様

### 3.1. データベース設計

**1. `scenarios` (シナリオマスターテーブル)**

| カラム名 | 型 | 説明 |
| :--- | :--- | :--- |
| `id` | `SERIAL PRIMARY KEY` | シナリオID |
| `campaign_id` | `INTEGER` | 所属するキャンペーンのID |
| `name` | `VARCHAR(100)` | シナリオ名 |
| `description` | `TEXT` | 背景ストーリー |
| `initial_state` | `JSONB` | 初期資源、初期技術、初期配置などのデータ |
| `victory_conditions`| `JSONB` | 勝利条件の定義 (例: `{ "type": "reach_population", "value": 1000 }`) |
| `defeat_conditions` | `JSONB` | 敗北条件の定義 |
| `special_rules` | `JSONB` | 特殊ルールの定義 (例: `{ "modifier": "resource_penalty", "value": 0.2 }`) |

**2. `user_scenario_progress` (ユーザーのシナリオ進捗テーブル)**

| カラム名 | 型 | 説明 |
| :--- | :--- | :--- |
| `id` | `SERIAL PRIMARY KEY` | 進捗ID |
| `user_id` | `INTEGER` | ユーザーID |
| `scenario_id` | `INTEGER` | シナリオID |
| `status` | `VARCHAR(20)` | 状態 (locked, unlocked, completed) |
| `best_score` | `INTEGER` | 最高スコア |
| `fastest_clear_time`| `INTEGER` | 最速クリアタイム(秒) |

### 3.2. バックエンド (Rust / Actix Web)

-   **ゲームロジック**:
    -   `game_loop` に、シナリオの勝利・敗北条件を判定するロジックを追加。
    -   毎サイクルの終わりに条件をチェックし、結果をフロントエンドに送信する。
-   **シナリオ管理サービス**:
    -   `application/services` に `scenario_service.rs` を新設。
    -   シナリオの開始、状態のロード、進捗の保存などを行う。
-   **APIエンドポイント**:
    -   `GET /api/scenarios`: 挑戦可能なシナリオの一覧を返す。
    -   `POST /api/scenarios/:id/start`: 新しいシナリオプレイを開始する。
    -   `GET /api/scenarios/progress`: ユーザーの全シナリオの進捗状況を返す。

### 3.3. フロントエンド (TypeScript / Three.js)

-   **状態管理**:
    -   現在のシナリオ目標、進捗、特殊ルールなどを管理する状態を追加。
-   **UIコンポーネント**:
    -   シナリオ選択画面を新規作成。
    -   目標表示UI、イベントダイアログ、リザルト画面を新規作成。

## 4. 開発計画

### 4.1. タスク分割

-   **フェーズ1: バックエンド実装** (見積もり: 6人日)
    -   [ ] DBマイグレーションとテーブル定義
    -   [ ] シナリオマスターデータの設計と投入
    -   [ ] シナリオ管理サービスとAPIエンドポイントの実装
    -   [ ] ゲームループへの勝利/敗北判定ロジックの組み込み
-   **フェーズ2: フロントエンド実装** (見積もり: 5人日)
    -   [ ] シナリオ選択画面の実装
    -   [ ] ゲーム内UI（目標表示、イベントダイアログ）の実装
    -   [ ] リザルト画面の実装
    -   [ ] APIとの連携
-   **フェーズ3: コンテンツ作成とテスト** (見積もり: 4人日)
    -   [ ] チュートリアルキャンペーン（3シナリオ）の作成
    -   [ ] E2Eテストの作成
    -   [ ] バランス調整とデバッグ

### 4.2. マイルストーン

-   **マイルストーン1 (1.5週目)**: バックエンド実装完了。API経由でシナリオを開始・管理できる。
-   **マイルストーン2 (2.5週目)**: フロントエンド実装完了。UIからシナリオをプレイし、クリア/失敗まで通しでプレイできる。
-   **マイルストーン3 (3週目)**: コンテンツ作成とテスト完了。リリース可能な品質になる。

## 5. 将来の展望

-   **コミュニティシナリオ**: プレイヤーが独自のシナリオを作成し、共有できるエディタ機能。
-   **高難易度コンテンツ**: エキスパートプレイヤー向けの、非常に難しいチャレンジシナリオを追加。
-   **ストーリーの拡張**: 新しいキャンペーンを追加し、Cosmic Gardenerの世界観をさらに掘り下げる。 
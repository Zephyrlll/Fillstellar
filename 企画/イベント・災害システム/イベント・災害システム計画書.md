# イベント・災害システム計画書

## 1. はじめに

本ドキュメントは、「Cosmic Gardener」のゲームプレイに予測不可能性と挑戦をもたらす「イベント・災害システム」の導入に関する計画を定義するものである。

### 1.1. 目的

本システムは、以下の目的のために導入する。

-   **ゲームプレイの多様化**: 静的で予測可能な環境にランダムな事象を導入し、マンネリ化を防ぐ。
-   **戦略的意思決定の促進**: プレイヤーに予期せぬ事態への対応を迫り、適応力と戦略的な思考を試す。
-   **世界観の深化**: 宇宙が常に安定しているわけではなく、動的で危険な場所でもあることを表現し、リアリティと没入感を高める。
-   **新たなチャンスの提供**: 災害だけでなく、プレイヤーにとって有益な機会となるポジティブなイベントも発生させる。

## 2. 機能要件

### 2.1. イベントの分類

イベントは、プレイヤーへの影響に応じていくつかのカテゴリに分類される。

-   **災害イベント (ネガティブ)**: プレイヤーの生産活動や宇宙環境に悪影響を及ぼす。
-   **好機イベント (ポジティブ)**: プレイヤーにボーナスや特別な機会を提供する。
-   **中立イベント**: ゲームの世界観を表現するフレーバー的なイベント。直接的な損得は少ない。

### 2.2. イベント発生メカニズム

-   イベントは、一定のプレイ時間が経過すると、ランダムな間隔で発生する。
-   発生確率は、ゲームの進行度（例: 総エネルギー生産量、経過時間）に応じて上昇する。
-   特定の条件（例: 特定の天体を所有している、特定技術を研究済み）を満たすことで、ユニークなイベントが解放される。

### 2.3. イベントの例

| 分類 | イベント名 | 発生条件 | 効果 | 対処法/活用法 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **災害** | 超新星爆発 | 巨大な恒星が寿命を迎える。 | 周辺の惑星の生命が死滅し、一定期間資源生産が停止する。爆発後には中性子星やブラックホールが残る。 | 事前に予測し、周辺から資源や重要施設を移動させる。「星系シールド」技術で被害を軽減する。 |
| **災害** | 宇宙嵐 | ランダム | 全域のエネルギー生産量が一定時間50%低下する。 | エネルギー備蓄量を増やしておく。特定の研究で嵐のエネルギーを逆に吸収できる。 |
| **好機** | 彗星の飛来 | ランダム | プレイヤーの宇宙を彗星が通過する。彗星に「資源探査機」を送ると大量の希少資源（有機物、バイオマス）を獲得できる。 | 彗星が領域を通過する前に探査機を準備・派遣する。 |
| **好機** | 知的生命体からの信号 | 知的生命体が存在する惑星がある。 | 信号を解読する研究プロジェクトが発生。完了すると、大量の思考ポイントとユニークな技術を獲得できる。 | 研究リソースを集中投下して、プロジェクトを早期に完了させる。 |
| **中立** | オーロラの発生 | ガス惑星がある。 | 特定の惑星で美しいオーロラが観測される。フレーバーテキストが表示されるのみ。 | スクリーンショットを撮る。 |

### 2.4. UI/UX

-   **イベント通知**:
    -   イベント発生時、画面上部に警告バーや通知ボックスを表示し、イベント名と影響を簡潔に伝える。
    -   緊急性の高い災害には、専用の警告音と画面エフェクト（例: 画面が赤く点滅）を使用する。
-   **イベントログ**:
    -   過去に発生したイベントの履歴を確認できるログ画面をメニュー内に追加する。

## 3. 技術仕様

### 3.1. データベース設計

**`events` (イベントマスターテーブル)**

| カラム名 | 型 | 説明 |
| :--- | :--- | :--- |
| `id` | `SERIAL PRIMARY KEY` | イベントID |
| `name` | `VARCHAR(100)` | イベント名 |
| `description` | `TEXT` | イベントの説明 |
| `type` | `VARCHAR(20)` | イベント分類 (disaster, opportunity, neutral) |
| `trigger_conditions` | `JSONB` | 発生条件の定義 |
| `effects` | `JSONB` | ゲーム状態への影響を定義 (例: `{ "modifier": "global_energy_output", "value": -0.5, "duration": 300 }`) |
| `weight` | `INTEGER` | 発生確率の重み付け |

### 3.2. バックエンド (Rust / Actix Web)

-   **イベントスケジューラ**:
    -   `application/services` に `event_scheduler.rs` を新設。
    -   ゲームループとは別に、非同期で実行されるタスクとして実装する。
    -   定期的にイベント発生の判定を行い、条件を満たした場合にイベントをトリガーする。
-   **イベントハンドラ**:
    -   トリガーされたイベントの `effects` を解釈し、ゲーム状態 (`game_state`) に適用するロジックを実装する。
    -   資源生産量の変更、天体の状態変化、新規プロジェクトの追加など、様々な効果に対応できる柔軟な設計が必要。
-   **WebSocket通信**:
    -   イベント発生時、`EventTriggered` メッセージを定義し、クライアントに情報をプッシュしてUIを更新させる。

### 3.3. フロントエンド (TypeScript / Three.js)

-   **イベント通知UI**:
    -   警告バーや通知ダイアログなど、イベントの種類に応じたUIコンポーネントを作成する。
-   **WebSocketハンドラ**:
    -   `EventTriggered` メッセージを受信し、対応する通知UIを表示し、必要に応じてサウンドや画面エフェクトを再生する。
-   **3Dエフェクト**:
    -   超新星爆発や宇宙嵐など、視覚的な表現が必要なイベントには、Three.jsのパーティクルシステムやシェーダーを用いて表現する。

## 4. 開発計画

### 4.1. タスク分割

-   **フェーズ1: バックエンド基盤構築** (見積もり: 5人日)
    -   [ ] DBテーブル設計とマイグレーション
    -   [ ] イベントマスターデータの投入
    -   [ ] イベントスケジューラとハンドラの基本ロジック実装
    -   [ ] WebSocket通知機能の実装
-   **フェーズ2: フロントエンド実装** (見積もり: 4人日)
    -   [ ] イベント通知UIコンポーネントの実装
    -   [ ] WebSocketメッセージ受信とUI連動
    -   [ ] イベントログ画面の実装
-   **フェーズ3: コンテンツ作成とテスト** (見積もり: 6人日)
    -   [ ] 10種類程度の初期イベント（災害、好機、中立）の具体的な効果ロジックとデータ作成
    -   [ ] 超新星爆発などの視覚エフェクト作成
    -   [ ] E2Eテストとバランス調整

### 4.2. マイルストーン

-   **マイルストーン1 (1週目)**: バックエンド実装完了。サーバーサイドでイベントが時間経過により発生し、ログで確認できる状態。
-   **マイルストーン2 (2週目)**: フロントエンド実装完了。UI上にイベント発生が通知される。
-   **マイルストーン3 (3週目)**: コンテンツ作成完了。リリース可能な一通りのイベントとエフェクトが実装されている。

## 5. 将来の展望

-   **連鎖イベント**: 1つのイベントが別のイベントの発生条件となり、連続したショートストーリーが展開される。
-   **プレイヤーの選択**: イベント発生時にプレイヤーに複数の選択肢を提示し、その選択によって結果が変化するインタラクティブなイベント。
-   **グローバルイベント**: 全プレイヤー共通の目標を持つ、期間限定のグローバルイベントを導入する（マルチプレイヤー機能との連携）。 
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resolution Scaling Debug</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #111;
            color: #fff;
        }
        
        .debug-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .canvas-container {
            border: 2px solid #444;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }
        
        .debug-info {
            background: #222;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
        }
        
        canvas {
            display: block;
            border: 1px solid #666;
        }
        
        .controls {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        button {
            background: #555;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        
        button:hover {
            background: #666;
        }
        
        .active {
            background: #007acc !important;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>è§£åƒåº¦ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ä»•çµ„ã¿è§£æ</h1>
        
        <div class="controls">
            <label>ç”»é¢ã‚µã‚¤ã‚º (ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ):</label>
            <button onclick="setViewportSize(1920, 1080)">1920x1080</button>
            <button onclick="setViewportSize(1366, 768)">1366x768</button>
            <button onclick="setViewportSize(800, 600)">800x600</button>
            
            <br><br>
            
            <label>è§£åƒåº¦ã‚¹ã‚±ãƒ¼ãƒ«:</label>
            <button onclick="applyScale(0.25)" data-scale="0.25">25%</button>
            <button onclick="applyScale(0.5)" data-scale="0.5">50%</button>
            <button onclick="applyScale(1.0)" data-scale="1.0" class="active">100%</button>
            <button onclick="applyScale(1.5)" data-scale="1.5">150%</button>
            <button onclick="applyScale(2.0)" data-scale="2.0">200%</button>
            <button onclick="applyScale(3.0)" data-scale="3.0">300%</button>
        </div>
        
        <div class="debug-info" id="debug-info">
            <strong>Debugæƒ…å ±:</strong><br>
            <span id="debug-text">åˆæœŸåŒ–ä¸­...</span>
        </div>
        
        <div class="canvas-container" id="canvas-container">
            <canvas id="test-canvas" width="800" height="600"></canvas>
        </div>
        
        <div class="debug-info">
            <h3>ğŸ“Š è§£åƒåº¦ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã®ä»•çµ„ã¿</h3>
            <ul>
                <li><strong>è¡¨ç¤ºã‚µã‚¤ã‚º (displayWidth/Height):</strong> CSSã§åˆ¶å¾¡ã•ã‚Œã‚‹è¦–è¦šçš„ãªã‚µã‚¤ã‚º</li>
                <li><strong>ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚µã‚¤ã‚º (renderWidth/Height):</strong> WebGLãŒå†…éƒ¨ã§ä½¿ç”¨ã™ã‚‹è§£åƒåº¦</li>
                <li><strong>50%ã‚¹ã‚±ãƒ¼ãƒ«:</strong> ãƒ¬ãƒ³ãƒ€ãƒ¼è§£åƒåº¦ã‚’åŠåˆ†ã«ã—ã¦è»½é‡åŒ–ã€è¡¨ç¤ºã¯æ‹¡å¤§</li>
                <li><strong>200%ã‚¹ã‚±ãƒ¼ãƒ«:</strong> ãƒ¬ãƒ³ãƒ€ãƒ¼è§£åƒåº¦ã‚’å€ã«ã—ã¦é«˜å“è³ªåŒ–ã€è¡¨ç¤ºã¯ç¸®å°</li>
                <li><strong>renderer.setSize(w, h, false):</strong> ç¬¬3å¼•æ•°falseã§CSSè‡ªå‹•æ›´æ–°ã‚’ç„¡åŠ¹åŒ–</li>
                <li><strong>canvas.styleè¨­å®š:</strong> è¡¨ç¤ºã‚µã‚¤ã‚ºã‚’æ‰‹å‹•ã§åˆ¶å¾¡</li>
            </ul>
        </div>
    </div>

    <script>
        let currentScale = 1.0;
        let viewportWidth = 1920;
        let viewportHeight = 1080;
        
        const canvas = document.getElementById('test-canvas');
        const container = document.getElementById('canvas-container');
        const debugText = document.getElementById('debug-text');
        
        function setViewportSize(width, height) {
            viewportWidth = width;
            viewportHeight = height;
            
            // ã‚³ãƒ³ãƒ†ãƒŠã‚µã‚¤ã‚ºã‚’æ›´æ–°
            container.style.width = width + 'px';
            container.style.height = height + 'px';
            
            // ç¾åœ¨ã®ã‚¹ã‚±ãƒ¼ãƒ«ã‚’å†é©ç”¨
            applyScale(currentScale);
        }
        
        function applyScale(scale) {
            currentScale = scale;
            
            // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('button[data-scale]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`button[data-scale="${scale}"]`)?.classList.add('active');
            
            // === Three.js applyResolutionScale() ã®å®Ÿè£…ã‚’å†ç¾ ===
            
            // 1. è¡¨ç¤ºã‚µã‚¤ã‚ºï¼ˆå¸¸ã«ç”»é¢ã„ã£ã±ã„ï¼‰
            const displayWidth = viewportWidth;
            const displayHeight = viewportHeight;
            
            // 2. å†…éƒ¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°è§£åƒåº¦ï¼ˆå“è³ªã«å½±éŸ¿ï¼‰
            const renderWidth = Math.round(displayWidth * scale);
            const renderHeight = Math.round(displayHeight * scale);
            
            // 3. Canvaså†…éƒ¨è§£åƒåº¦ã‚’è¨­å®šï¼ˆWebGLãƒãƒƒãƒ•ã‚¡ã‚µã‚¤ã‚ºï¼‰
            canvas.width = renderWidth;
            canvas.height = renderHeight;
            
            // 4. CSSè¡¨ç¤ºã‚µã‚¤ã‚ºã‚’å¼·åˆ¶è¨­å®šï¼ˆè§£åƒåº¦ã‚¹ã‚±ãƒ¼ãƒ«ã«é–¢ä¿‚ãªãå¸¸ã«ç”»é¢ã„ã£ã±ã„ï¼‰
            canvas.style.width = displayWidth + 'px';
            canvas.style.height = displayHeight + 'px';
            
            // 5. ç°¡å˜ãªæç”»ã§ãƒ†ã‚¹ãƒˆ
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#000033';
            ctx.fillRect(0, 0, renderWidth, renderHeight);
            
            // ã‚°ãƒªãƒƒãƒ‰æç”»ï¼ˆè§£åƒåº¦ç¢ºèªç”¨ï¼‰
            ctx.strokeStyle = '#444444';
            ctx.lineWidth = 1;
            const gridSize = Math.max(50, renderWidth / 40);
            
            for (let x = 0; x < renderWidth; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, renderHeight);
                ctx.stroke();
            }
            
            for (let y = 0; y < renderHeight; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(renderWidth, y);
                ctx.stroke();
            }
            
            // ä¸­å¤®ã«ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º
            ctx.fillStyle = '#ffffff';
            ctx.font = `${Math.max(16, renderWidth / 60)}px Arial`;
            ctx.textAlign = 'center';
            ctx.fillText(
                `${Math.round(scale * 100)}% Scale`,
                renderWidth / 2,
                renderHeight / 2 - 20
            );
            ctx.fillText(
                `Render: ${renderWidth}x${renderHeight}`,
                renderWidth / 2,
                renderHeight / 2 + 10
            );
            ctx.fillText(
                `Display: ${displayWidth}x${displayHeight}`,
                renderWidth / 2,
                renderHeight / 2 + 40
            );
            
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’æ›´æ–°
            updateDebugInfo(scale, displayWidth, displayHeight, renderWidth, renderHeight);
        }
        
        function updateDebugInfo(scale, displayWidth, displayHeight, renderWidth, renderHeight) {
            const pixelRatio = window.devicePixelRatio || 1;
            const cssWidth = canvas.style.width;
            const cssHeight = canvas.style.height;
            const actualWidth = canvas.width;
            const actualHeight = canvas.height;
            const clientWidth = canvas.clientWidth;
            const clientHeight = canvas.clientHeight;
            
            const debugInfo = `
ç¾åœ¨ã®è¨­å®š: ${Math.round(scale * 100)}% ã‚¹ã‚±ãƒ¼ãƒ«

ğŸ“ ã‚µã‚¤ã‚ºè¨ˆç®—:
â€¢ è¡¨ç¤ºã‚µã‚¤ã‚º: ${displayWidth} x ${displayHeight} px
â€¢ ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚µã‚¤ã‚º: ${renderWidth} x ${renderHeight} px
â€¢ ã‚¹ã‚±ãƒ¼ãƒ«å€ç‡: ${scale} (${scale < 1 ? 'è»½é‡åŒ–' : scale > 1 ? 'é«˜å“è³ªåŒ–' : 'æ¨™æº–'})

ğŸ–¥ï¸ Canvas ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£:
â€¢ canvas.width: ${actualWidth} (WebGLæç”»è§£åƒåº¦)
â€¢ canvas.height: ${actualHeight} (WebGLæç”»è§£åƒåº¦)
â€¢ canvas.style.width: ${cssWidth} (CSSè¡¨ç¤ºå¹…)
â€¢ canvas.style.height: ${cssHeight} (CSSè¡¨ç¤ºé«˜)
â€¢ canvas.clientWidth: ${clientWidth} (å®Ÿéš›ã®è¡¨ç¤ºå¹…)
â€¢ canvas.clientHeight: ${clientHeight} (å®Ÿéš›ã®è¡¨ç¤ºé«˜)

âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å½±éŸ¿:
â€¢ ãƒ”ã‚¯ã‚»ãƒ«æ•°: ${(renderWidth * renderHeight).toLocaleString()} (${Math.round(scale * scale * 100)}%ã®è² è·)
â€¢ devicePixelRatio: ${pixelRatio}

${scale < 1 ? 
  'ğŸ”½ ã‚¢ãƒƒãƒ—ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°: ä½è§£åƒåº¦ã§æç”»â†’CSSæ‹¡å¤§è¡¨ç¤ºï¼ˆè»½é‡ãƒ»ç”»è³ªåŠ£åŒ–ï¼‰' : 
  scale > 1 ? 
  'ğŸ”¼ ãƒ€ã‚¦ãƒ³ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°: é«˜è§£åƒåº¦ã§æç”»â†’CSSç¸®å°è¡¨ç¤ºï¼ˆé‡ã„ãƒ»é«˜ç”»è³ªï¼‰' : 
  'ğŸ¯ ç­‰å€: è§£åƒåº¦ã¨è¡¨ç¤ºã‚µã‚¤ã‚ºãŒä¸€è‡´ï¼ˆæ¨™æº–ï¼‰'
}

${scale !== 1 ? 
  `ğŸ¨ è¦–è¦šåŠ¹æœ: ${renderWidth}x${renderHeight}ã®ç”»åƒã‚’${displayWidth}x${displayHeight}ã«${scale < 1 ? 'æ‹¡å¤§' : 'ç¸®å°'}è¡¨ç¤º` : 
  ''
}
            `.trim();
            
            debugText.textContent = debugInfo;
        }
        
        // åˆæœŸåŒ–
        setViewportSize(1920, 1080);
    </script>
</body>
</html>
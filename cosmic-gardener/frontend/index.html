<!DOCTYPE html>
<!-- 🚀 CAMERA FIX v2024-07-13-15:30 -->
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Gardener - Production System Update</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="favicon.png">
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
          "three/examples/jsm/controls/OrbitControls.js": "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js",
          "three/examples/jsm/postprocessing/EffectComposer.js": "https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/EffectComposer.js",
          "three/examples/jsm/postprocessing/RenderPass.js": "https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/RenderPass.js",
          "three/examples/jsm/postprocessing/UnrealBloomPass.js": "https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/UnrealBloomPass.js"
        }
      }
    </script>
    <!-- Cache Busting Debug -->
    <script>
      const timestamp = new Date().getTime();
      console.log('🚀 CAMERA FIX VERSION LOADING:', timestamp);
      window.graphicsDebug = true;
      window.cameraFixDebug = true;
    </script>
</head>
<body>
<script>
    console.log('🌟 Cosmic Gardener with CAMERA FIX loaded!');
    console.log('📅 Version: 2024-07-13 CAMERA FIX');
    console.log('🎯 Camera positioning bug fix active');
</script>

  <!-- 🔧 初期化フェードオーバーレイ -->
  <div id="fade-overlay">
    <div id="loading-content">
      <h1>Cosmic Gardener</h1>
    </div>
  </div>

  <!-- 上部中央の情報表示 -->
  <div id="info-container">
    <div id="year-display">年: <span id="gameYear">0</span></div>
    <div id="thought-speed-display">思考速度: <span id="thoughtSpeedMps">0</span> m/s (<span id="lightSpeedPercent">0.00</span>%)</div>
  </div>

  <div id="game-container">
    <canvas id="game-canvas"></canvas>

    <!-- メッセージオーバーレイ -->
    <div id="message-overlay" class="hidden">
        <p id="message-text"></p>
    </div>

    <!-- フォーカス中の天体詳細 -->
    <div id="focused-celestial-body-details">
        <p id="focused-star-name">フォーカス中の星はありません</p>
        <div id="star-parameters" class="hidden">
            <p>年齢: <span id="focused-star-age">--</span></p>
            <p>温度: <span id="focused-star-temp">--</span> K</p>
            <p>質量: <span id="focused-star-mass">--</span> 太陽質量</p>
            <p>寿命: <span id="focused-star-lifespan">--</span> 億年</p>
            <p>速度: <span id="focused-star-speed">--</span> km/s</p>
        </div>
        <div id="planet-parameters" class="hidden">
            <p>種類: <span id="focused-planet-type">--</span></p>
            <p>質量: <span id="focused-planet-mass">--</span> 地球質量</p>
            <p>半径: <span id="focused-planet-radius">--</span> 地球半径</p>
            <p>大気: <span id="focused-planet-atmosphere">--</span></p>
            <p>水: <span id="focused-planet-water">--</span></p>
            <p>居住可能性: <span id="focused-planet-habitability">--</span> %</p>
            <p id="focused-planet-geology-row" style="display: none;">地質活動: <span id="focusedPlanetGeology">--</span> %</p>
            <p>生命: <span id="focused-planet-hasLife">--</span></p>
            <p>生命段階: <span id="focused-planet-lifeStage">--</span></p>
            <p>人口: <span id="focused-planet-population">--</span></p>
            <p>速度: <span id="focused-planet-speed">--</span> km/s</p>
        </div>
    </div>

    <!-- 左側のUIエリア -->
    <div id="ui-area">
      <div id="tab-buttons">
        <button id="gameTabButton" class="active-tab">ゲーム</button>
        <button id="researchTabButton">研究</button>
        <button id="optionsTabButton">オプション</button>
        <button id="starManagementTabButton">恒星管理</button>
      </div>
      

      <!-- ゲームタブ -->
      <div id="game-screen">
        <div id="ui-panel">
          <h1>Cosmic Gardener</h1>
          <div id="resource-display">
             <p>宇宙の塵: <span id="resource-cosmicDust">0</span></p>
             <p class="dust-rate">入手速度: <span id="dustRate">0</span>/秒</p>
             <p>エネルギー: <span id="resource-energy">0</span></p>
             <p>有機物: <span id="resource-organicMatter">0</span></p>
             <p>バイオマス: <span id="resource-biomass">0</span></p>
             <p>ダークマター: <span id="resource-darkMatter">0</span></p>
             <p>思考ポイント: <span id="resource-thoughtPoints">0</span></p>
             <p>天体の数: <span id="starCount">0</span></p>
          </div>


          <div class="collapsible-section">
            <div class="collapsible-header active" id="coreActionsHeader">創造</div>
            <div class="collapsible-content active" id="coreActionsContent">
              <div class="creation-item">
                  <p>小惑星 (コスト: <span id="asteroidCostDisplay">100</span> 塵)</p>
                  <button id="createAsteroidButton">創造</button>
              </div>
              <div class="creation-item">
                  <p>彗星 (コスト: <span id="cometCostDisplay">500</span> 塵)</p>
                  <button id="createCometButton">創造</button>
              </div>
              <div class="creation-item">
                  <p>衛星 (コスト: <span id="moonCostDisplay">1000</span> 塵)</p>
                  <button id="createMoonButton" style="display: none;">創造</button>
              </div>
              <div class="creation-item">
                  <p>準惑星 (コスト: <span id="dwarfPlanetCostDisplay">2500</span> 塵)</p>
                  <button id="createDwarfPlanetButton" style="display: none;">創造</button>
              </div>
              <div class="creation-item">
                  <p>惑星 (コスト: <span id="planetCostDisplay">10000</span> 塵)</p>
                  <button id="createPlanetButton" style="display: none;">創造</button>
              </div>
              <div class="creation-item">
                  <p>恒星 (コスト: <span id="starCostDisplay">100000</span> 塵)</p>
                  <button id="createStarButton" style="display: none;">創造</button>
              </div>
            </div>
          </div>

          <div class="collapsible-section">
            <div class="collapsible-header" id="upgradesHeader">アップグレード</div>
            <div class="collapsible-content" id="upgradesContent">
               <div class="upgrade-item">
                    <p>塵生成 Lv: <span id="dustUpgradeLevel">0</span></p>
                    <p>コスト: <span id="dustUpgradeCost">100</span> エネルギー</p>
                    <button id="upgradeDustButton">アップグレード</button>
                </div>
                <div class="upgrade-item">
                    <p>ダークマター変換器 Lv: <span id="darkMatterConverterLevel">0</span></p>
                    <p>コスト: <span id="darkMatterConverterCost">500</span> エネルギー</p>
                    <button id="upgradeDarkMatterConverterButton">変換</button>
                </div>
            </div>
          </div>
        </div>
      </div>


      <!-- 研究タブ -->
      <div id="research-screen" class="hidden-screen">
        <div id="ui-panel-research">
            <h1>研究</h1>
             <div class="research-item">
                <p>強化された塵生成 (コスト: 1 DM)</p>
                <p>状態: <span id="researchEnhancedDustStatus"></span></p>
                <button id="researchEnhancedDustButton">研究する</button>
            </div>
            <div class="research-item">
                <p>高度なエネルギー変換 (コスト: 2 DM)</p>
                <p>状態: <span id="researchAdvancedEnergyStatus"></span></p>
                <button id="researchAdvancedEnergyButton">研究する</button>
            </div>
            <div class="research-item">
                <p>軌道力学 (衛星アンロック) (コスト: 1 DM)</p>
                <p>状態: <span id="researchMoonStatus"></span></p>
                <button id="researchMoonButton">研究する</button>
            </div>
            <div class="research-item">
                <p>準惑星学 (準惑星アンロック) (コスト: 2 DM)</p>
                <p>状態: <span id="researchDwarfPlanetStatus"></span></p>
                <button id="researchDwarfPlanetButton">研究する</button>
            </div>
            <div class="research-item">
                <p>惑星形成論 (惑星アンロック) (コスト: 3 DM)</p>
                <p>状態: <span id="researchPlanetStatus"></span></p>
                <button id="researchPlanetButton">研究する</button>
            </div>
            <div class="research-item">
                <p>恒星発生論 (恒星アンロック) (コスト: <span id="researchStarCost">5</span> DM)</p>
                <p>状態: <span id="researchStarStatus"></span></p>
                <button id="researchStarButton">研究する</button>
            </div>
        </div>
      </div>


      <!-- オプションタブ -->
      <div id="options-screen" class="hidden-screen">
          <h1>オプション</h1>
          <div id="options-content-wrapper">
              
              <!-- グラフィック設定セクション -->
              <div class="collapsible-section">
                  <div class="collapsible-header" id="graphicsHeader">🎮 グラフィック設定</div>
                  <div class="collapsible-content hidden" id="graphicsContent">
                      
                      <!-- プリセット選択 -->
                      <div class="option-item">
                          <label for="graphicsPresetSelect">プリセット:</label>
                          <select id="graphicsPresetSelect">
                              <option value="extreme">エクストリーム (300%)</option>
                              <option value="ultra">ウルトラ (200%)</option>
                              <option value="high">高</option>
                              <option value="medium" selected>中</option>
                              <option value="low">低</option>
                              <option value="minimal">最小</option>
                              <option value="custom">カスタム</option>
                          </select>
                      </div>
                      
                      <!-- パフォーマンス表示 -->
                      <div class="option-item performance-display">
                          <div class="performance-stats">
                              <span>FPS: <span id="fpsDisplay">60</span></span>
                              <span>フレーム時間: <span id="frameTimeDisplay">16.7</span>ms</span>
                              <span>メモリ: <span id="memoryDisplay">0</span>MB</span>
                          </div>
                          <div class="device-info">
                              <span>GPU: <span id="gpuDisplay">検出中...</span></span>
                              <span>推奨: <span id="recommendedPresetDisplay">中</span></span>
                          </div>
                      </div>
                      
                      <!-- 詳細設定セクション -->
                      <div class="collapsible-section">
                          <div class="collapsible-header" id="detailedGraphicsHeader">🔧 詳細設定</div>
                          <div class="collapsible-content hidden" id="detailedGraphicsContent">
                              <div class="graphics-settings-grid">
                          
                          <div class="option-item">
                              <label for="resolutionScaleSelect">解像度スケール:</label>
                              <select id="resolutionScaleSelect">
                                  <option value="25">25% (最低品質)</option>
                                  <option value="50">50% (低品質)</option>
                                  <option value="75">75% (中品質)</option>
                                  <option value="100" selected>100% (標準)</option>
                                  <option value="125">125% (高品質)</option>
                                  <option value="150">150% (超高品質)</option>
                                  <option value="200">200% (ウルトラ高品質)</option>
                                  <option value="300">300% (極限品質)</option>
                              </select>
                          </div>
                          
                          <div class="option-item">
                              <label for="textureQualitySelect">テクスチャ品質:</label>
                              <select id="textureQualitySelect">
                                  <option value="ultra">ウルトラ</option>
                                  <option value="high">高</option>
                                  <option value="medium" selected>中</option>
                                  <option value="low">低</option>
                              </select>
                          </div>
                          
                          <div class="option-item">
                              <label for="shadowQualitySelect">シャドウ品質:</label>
                              <select id="shadowQualitySelect">
                                  <option value="ultra">ウルトラ</option>
                                  <option value="high">高</option>
                                  <option value="medium" selected>中</option>
                                  <option value="low">低</option>
                                  <option value="off">オフ</option>
                              </select>
                          </div>
                          
                          <div class="option-item">
                              <label for="antiAliasingSelect">アンチエイリアシング:</label>
                              <select id="antiAliasingSelect">
                                  <option value="msaa8x">8x MSAA</option>
                                  <option value="msaa4x">4x MSAA</option>
                                  <option value="msaa2x">2x MSAA</option>
                                  <option value="fxaa" selected>FXAA</option>
                                  <option value="off">オフ</option>
                              </select>
                          </div>
                          
                          <div class="option-item">
                              <label for="postProcessingSelect">ポストプロセッシング:</label>
                              <select id="postProcessingSelect">
                                  <option value="ultra">ウルトラ</option>
                                  <option value="high">高</option>
                                  <option value="medium" selected>中</option>
                                  <option value="low">低</option>
                                  <option value="off">オフ</option>
                              </select>
                          </div>
                          
                          <div class="option-item">
                              <label for="particleDensitySelect">パーティクル密度:</label>
                              <select id="particleDensitySelect">
                                  <option value="10">10% (極少)</option>
                                  <option value="25">25% (少)</option>
                                  <option value="50" selected>50% (標準)</option>
                                  <option value="75">75% (多)</option>
                                  <option value="100">100% (極多)</option>
                                  <option value="125">125% (超高密度)</option>
                              </select>
                          </div>
                          
                          <div class="option-item">
                              <label for="viewDistanceSelect">描画距離:</label>
                              <select id="viewDistanceSelect">
                                  <option value="unlimited">無制限</option>
                                  <option value="far">遠距離</option>
                                  <option value="medium" selected>中距離</option>
                                  <option value="near">近距離</option>
                                  <option value="minimal">最小</option>
                              </select>
                          </div>
                          
                          <div class="option-item">
                              <label for="frameRateLimitSelect">フレームレート制限:</label>
                              <select id="frameRateLimitSelect">
                                  <option value="-1">無制限</option>
                                  <option value="144">144 FPS</option>
                                  <option value="120">120 FPS</option>
                                  <option value="60" selected>60 FPS</option>
                                  <option value="30">30 FPS</option>
                              </select>
                          </div>
                          
                          <div class="option-item">
                              <label for="lightingQualitySelect">ライティング品質:</label>
                              <select id="lightingQualitySelect">
                                  <option value="ultra">ウルトラ</option>
                                  <option value="high">高</option>
                                  <option value="medium" selected>中</option>
                                  <option value="low">低</option>
                              </select>
                          </div>
                          
                          <div class="option-item">
                              <label for="fogEffectSelect">フォグ効果:</label>
                              <select id="fogEffectSelect">
                                  <option value="high">高</option>
                                  <option value="standard" selected>標準</option>
                                  <option value="simple">シンプル</option>
                                  <option value="off">オフ</option>
                              </select>
                          </div>
                          
                          <div class="option-item">
                              <label for="objectDetailSelect">オブジェクト詳細度:</label>
                              <select id="objectDetailSelect">
                                  <option value="ultra">ウルトラ</option>
                                  <option value="high">高</option>
                                  <option value="medium" selected>中</option>
                                  <option value="low">低</option>
                              </select>
                          </div>
                          
                          <div class="option-item">
                              <label for="backgroundDetailSelect">背景詳細度:</label>
                              <select id="backgroundDetailSelect">
                                  <option value="high">高</option>
                                  <option value="standard" selected>標準</option>
                                  <option value="simple">シンプル</option>
                                  <option value="off">オフ</option>
                              </select>
                          </div>
                          
                              </div>
                          </div>
                      </div>
                      
                      <!-- 動的品質調整 -->
                      <div class="option-item">
                          <label>
                              <input type="checkbox" id="dynamicQualityCheckbox">
                              動的品質調整 (FPS低下時に自動で設定を下げる)
                          </label>
                      </div>
                      
                      <!-- リセットボタン -->
                      <div class="option-item">
                          <button id="resetGraphicsButton" class="reset-button">設定をリセット</button>
                      </div>
                      
                  </div>
              </div>
              
              <!-- その他の設定 -->
              <div class="collapsible-section">
                  <div class="collapsible-header" id="generalSettingsHeader">⚙️ 一般設定</div>
                  <div class="collapsible-content hidden" id="generalSettingsContent">
                      
                      <div class="option-item">
                          <label for="unitSystemSelect">単位系:</label>
                          <select id="unitSystemSelect">
                              <option value="astronomical">天文学単位</option>
                              <option value="si">SI単位</option>
                          </select>
                      </div>
                      
                      <div class="option-item">
                          <label for="uiAnimationsSelect">UIアニメーション:</label>
                          <select id="uiAnimationsSelect">
                              <option value="smooth">スムーズ</option>
                              <option value="standard" selected>標準</option>
                              <option value="simple">シンプル</option>
                              <option value="off">オフ</option>
                          </select>
                      </div>
                      
                  </div>
              </div>

              <div class="collapsible-section">
                <div class="collapsible-header" id="timeAccelerationHeader">⏰ 時間加速</div>
                <div class="collapsible-content hidden" id="timeAccelerationContent">
                    <div class="option-item">
                        <label for="timeMultiplierSelect">現在の倍率:</label>
                        <select id="timeMultiplierSelect">
                            <option value="1">1x</option>
                            <option value="2" disabled>2x</option>
                            <option value="5" disabled>5x</option>
                            <option value="10" disabled>10x</option>
                        </select>
                    </div>
                    <div class="research-item">
                        <p>2x 加速アンロック (コスト: <span id="timeMultiplier2xCost">--</span> TP)</p>
                        <p>状態: <span id="timeMultiplier2xStatus">--</span></p>
                        <button id="timeMultiplier2xButton">アンロック</button>
                    </div>
                    <div class="research-item">
                        <p>5x 加速アンロック (コスト: <span id="timeMultiplier5xCost">--</span> TP)</p>
                        <p>状態: <span id="timeMultiplier5xStatus">--</span></p>
                        <button id="timeMultiplier5xButton">アンロック</button>
                    </div>
                    <div class="research-item">
                        <p>10x 加速アンロック (コスト: <span id="timeMultiplier10xCost">--</span> TP)</p>
                        <p>状態: <span id="timeMultiplier10xStatus">--</span></p>
                        <button id="timeMultiplier10xButton">アンロック</button>
                    </div>
                </div>
              </div>

              <div class="collapsible-section">
                <div class="collapsible-header" id="physicsHeader">🌌 物理設定</div>
                <div class="collapsible-content hidden" id="physicsContent">
                    <div class="option-item">
                        <label for="gravitySlider">万有引力定数 G: <span id="gravityValue">100</span></label>
                        <div class="slider-container">
                            <input type="range" id="gravitySlider" min="0" max="1000" value="100" step="1">
                        </div>
                    </div>
                    <div class="option-item">
                        <label for="simulationSpeedSlider">シミュレーション速度: <span id="simulationSpeedValue">1</span>x</label>
                        <div class="slider-container">
                            <input type="range" id="simulationSpeedSlider" min="0.1" max="5" value="1" step="0.1">
                        </div>
                    </div>
                    <div class="option-item">
                        <label for="dragSlider">宇宙抵抗: <span id="dragValue">0.01</span></label>
                        <div class="slider-container">
                            <input type="range" id="dragSlider" min="0" max="0.1" value="0.01" step="0.001">
                        </div>
                    </div>
                    <div class="option-item">
                        <label for="collisionDetectionCheckbox">
                            <input type="checkbox" id="collisionDetectionCheckbox" checked>
                            天体衝突システムを有効にする
                        </label>
                    </div>
                </div>
              </div>

              <div class="collapsible-section">
                <div class="collapsible-header" id="soundHeader">🔊 サウンド設定</div>
                <div class="collapsible-content hidden" id="soundContent">
                    <div class="option-item">
                        <label for="masterVolumeSlider">マスター音量: <span id="masterVolumeValue">70</span>%</label>
                        <div class="slider-container">
                            <input type="range" id="masterVolumeSlider" min="0" max="100" value="70" step="1">
                        </div>
                    </div>
                    <div class="option-item">
                        <label for="ambientVolumeSlider">環境音: <span id="ambientVolumeValue">60</span>%</label>
                        <div class="slider-container">
                            <input type="range" id="ambientVolumeSlider" min="0" max="100" value="60" step="1">
                        </div>
                    </div>
                    <div class="option-item">
                        <label for="effectsVolumeSlider">効果音: <span id="effectsVolumeValue">80</span>%</label>
                        <div class="slider-container">
                            <input type="range" id="effectsVolumeSlider" min="0" max="100" value="80" step="1">
                        </div>
                    </div>
                    <div class="option-item">
                        <label for="uiVolumeSlider">UI音: <span id="uiVolumeValue">50</span>%</label>
                        <div class="slider-container">
                            <input type="range" id="uiVolumeSlider" min="0" max="100" value="50" step="1">
                        </div>
                    </div>
                    <div class="option-item">
                        <label for="spatialAudioCheckbox">
                            <input type="checkbox" id="spatialAudioCheckbox" checked>
                            3D空間音響を有効にする
                        </label>
                    </div>
                    <div class="option-item">
                        <button id="muteToggleButton">ミュート</button>
                    </div>
                    <div class="option-item">
                        <button id="testSoundButton">サウンドテスト</button>
                    </div>
                </div>
              </div>

              <div class="collapsible-section">
                  <div class="collapsible-header" id="debugHeader">🐛 デバッグ</div>
                  <div class="collapsible-content hidden" id="debugContent">
                      <button id="addAllResourcesButton">全リソースを一括付与</button>
                      <button id="testCollisionButton">衝突テスト</button>
                      <button id="forceCollisionButton">強制衝突実行</button>
                      <!-- 
                      <button id="addCosmicDustButton">塵を10万追加</button>
                      <button id="addEnergyButton">エネルギーを10万追加</button>
                      <button id="addDarkMatterButton">DMを10追加</button>
                      -->
                      <button id="resetGameButton">ゲームをリセット</button>
                  </div>
              </div>
          </div>
          <button id="closeOptionsButton">閉じる</button>
      </div>

      <!-- 恒星管理タブ -->
      <div id="star-management-screen" class="hidden-screen">
          <h1>恒星管理</h1>
          <div id="star-list-container"></div>
      </div>
    </div>

    <!-- 右下の統計情報 -->
    <div id="game-stats-overlay">
        <p>塵: <span id="overlayCosmicDust">0</span></p>
        <p>エネルギー: <span id="overlayEnergy">0</span></p>
        <p>天体: <span id="overlayStarCount">0</span></p>
        <p>TP: <span id="overlayThoughtPoints">0</span></p>
        <p>活発度: <span id="overlayCosmicActivity">0</span></p>
        <p>人口: <span id="overlayPopulation">0</span></p>
        <hr>
        <div class="overlay-currency-section">
            <p>💫 <span id="overlayCurrencyCosmicDust">0</span></p>
            <p>💎 <span id="overlayCurrencyGalactic">0</span></p>
            <p>🏺 <span id="overlayCurrencyAncient">0</span></p>
        </div>
    </div>

    <!-- モダンなフローティングコントロール -->
    <div id="floating-controls">
        <button id="productionToggleButton" class="floating-btn production-btn" title="生産システムを開く">
            <div class="btn-icon">🏭</div>
            <div class="btn-label">生産システム</div>
        </button>
        <button id="floatingResourceSellButton" class="floating-btn sell-btn" title="資源を販売">
            <div class="btn-icon">💰</div>
            <div class="btn-label">資源販売</div>
        </button>
    </div>

    <!-- 銀河マップコンテナ -->
    <div id="galaxy-map-container"></div>

    <!-- 統計・ログパネル -->
    <div id="stats-log-container">
      <!-- タブボタン -->
      <div id="stats-log-tabs">
        <button id="stats-tab-button" class="stats-log-tab active">統計</button>
        <button id="log-tab-button" class="stats-log-tab">ログ</button>
        <span id="stats-log-toggle-icon">▲</span>
      </div>
      
      <!-- 統計パネル -->
      <div id="statistics-panel">
        <div id="statistics-content">
          <!-- リソース統計セクション -->
          <div id="resource-statistics" class="stats-section">
            <h3>リソース統計</h3>
            <div id="resource-stats-grid"></div>
          </div>
          
          <!-- 宇宙統計セクション -->
          <div id="cosmic-statistics" class="stats-section">
            <h3>宇宙統計</h3>
            <div id="cosmic-stats-grid"></div>
          </div>
          
          <!-- グラフセクション -->
          <div id="chart-section" class="stats-section">
            <h3>グラフ</h3>
            <div id="chart-tabs">
              <button class="chart-tab active" data-chart="resources">リソース</button>
              <button class="chart-tab" data-chart="cosmic">宇宙</button>
            </div>
            <canvas id="statistics-chart"></canvas>
          </div>
        </div>
      </div>
      
      <!-- 時系列ログパネル -->
      <div id="timeline-log-panel">
        <div id="timeline-log-content">
          <div id="timeline-log-entries"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 生産パネル（スライドアウト） -->
  <div id="production-panel" class="production-panel">
    <div class="production-panel-header">
      <h1>🏭 資源生産システム</h1>
      <button id="productionPanelCloseButton" class="close-btn">×</button>
    </div>
    
    <div class="production-panel-content">
      <!-- 高度な資源在庫 -->
      <div class="collapsible-section">
        <div class="collapsible-header active" id="advancedResourcesHeader">高度な資源</div>
        <div class="collapsible-content active" id="advancedResourcesContent">
          <div id="advanced-resources-display">
            <!-- Dynamically populated -->
          </div>
        </div>
      </div>
      
      <!-- リソース変動リアルタイム表示 -->
      <div class="collapsible-section">
        <div class="collapsible-header active" id="resourceFlowHeader">⚡ リソース変動リアルタイム</div>
        <div class="collapsible-content active" id="resourceFlowContent">
          <div id="resource-flow-display">
            <div class="flow-info">
              <p>💡 変換中のリソースの流れをリアルタイムで表示します</p>
            </div>
            <div id="active-flows-container">
              <!-- 動的に変換中のリソース変動を表示 -->
            </div>
          </div>
        </div>
      </div>
      
      <!-- 変換レシピ -->
      <div class="collapsible-section">
        <div class="collapsible-header active" id="conversionRecipesHeader">変換レシピ</div>
        <div class="collapsible-content active" id="conversionRecipesContent">
          <div id="conversion-recipes-list">
            <!-- Dynamically populated -->
          </div>
        </div>
      </div>
      
      <!-- アクティブな変換 -->
      <div class="collapsible-section">
        <div class="collapsible-header" id="activeConversionsHeader">アクティブな変換</div>
        <div class="collapsible-content" id="activeConversionsContent">
          <div id="active-conversions-list">
            <!-- Dynamically populated -->
          </div>
        </div>
      </div>
      
      <!-- 生産施設 -->
      <div class="collapsible-section">
        <div class="collapsible-header" id="productionFacilitiesHeader">生産施設</div>
        <div class="collapsible-content" id="productionFacilitiesContent">
          <div id="production-facilities-list">
            <!-- Dynamically populated -->
          </div>
        </div>
      </div>
      
      <!-- 施設建設 -->
      <div class="collapsible-section">
        <div class="collapsible-header" id="facilityConstructionHeader">施設建設</div>
        <div class="collapsible-content" id="facilityConstructionContent">
          <div id="facility-construction-list">
            <!-- Dynamically populated -->
          </div>
        </div>
      </div>
      
      <!-- 生産チェーン -->
      <div class="collapsible-section">
        <div class="collapsible-header" id="productionChainHeader">🔗 生産チェーン</div>
        <div class="collapsible-content" id="productionChainContent">
          <div class="production-subsection">
            <div id="production-chain-controls">
              <button id="productionChainToggleButton" class="production-chain-btn">
                🔗 チェーン表示切り替え
              </button>
              <div id="production-chain-info">
                <p>生産チェーンを可視化して効率的な資源フローを管理します</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 高度なモジュール -->
      <div class="collapsible-section">
        <div class="collapsible-header" id="moduleSystemHeader">🔧 高度なモジュール</div>
        <div class="collapsible-content" id="moduleSystemContent">
          
          <!-- Module Shop -->
          <div class="production-subsection">
            <h4>📦 モジュール購入</h4>
            <div id="module-shop-list">
              <!-- Populated dynamically -->
            </div>
          </div>
          
          <!-- Available Modules -->
          <div class="production-subsection">
            <h4>💼 所有モジュール</h4>
            <div id="available-modules-list">
              <!-- Populated dynamically -->
            </div>
          </div>
          
          <!-- Facility Module Management -->
          <div class="production-subsection">
            <h4>⚙️ モジュール管理</h4>
            <div id="facility-selector">
              <select id="facilitySelect">
                <option value="">施設を選択...</option>
                <!-- Populated dynamically -->
              </select>
            </div>
            <div id="selected-facility-info" class="hidden">
              <div class="facility-info">
                <h5 id="selectedFacilityName">施設名</h5>
                <div class="facility-slots">
                  スロット: <span id="usedSlots">0</span>/<span id="maxSlots">0</span>
                  <div class="slot-indicator" id="slotIndicator">
                    <!-- Slots populated dynamically -->
                  </div>
                </div>
                
                <div id="installed-modules-section">
                  <h6>設置済みモジュール</h6>
                  <div id="installed-modules-list">
                    <!-- Populated dynamically -->
                  </div>
                </div>
                
                <div id="installable-modules-section">
                  <h6>設置可能モジュール</h6>
                  <div id="installable-modules-list">
                    <!-- Populated dynamically -->
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Facility Upgrades -->
          <div class="production-subsection">
            <h4>🏭 施設アップグレード</h4>
            <div id="facility-upgrades-list">
              <!-- Populated dynamically -->
            </div>
          </div>
          
        </div>
      </div>
    </div>
  </div>

  <script type="module" src="./main.js?v=20240713-SYNC-FIX-3"></script>
  <script>
    console.log('🔧 HTML loaded, market system will be handled by events.js');
    
    // Debug: Test currency button directly
    document.addEventListener('DOMContentLoaded', () => {
        const currencyBtn = document.getElementById('floatingResourceSellButton');
        if (currencyBtn) {
            console.log('🔧 Currency button found');
            currencyBtn.addEventListener('click', () => {
                console.log('🔧 Currency button clicked directly!');
                
                // Wait for modules to load and try multiple times
                const tryShowModal = (attempts = 0) => {
                    if (window.showResourceSellModal) {
                        console.log('🔧 showResourceSellModal found, calling...');
                        window.showResourceSellModal();
                    } else if (attempts < 10) {
                        console.log('🔧 showResourceSellModal NOT found, retrying...', attempts + 1);
                        setTimeout(() => tryShowModal(attempts + 1), 100);
                    } else {
                        console.log('🔧 showResourceSellModal NOT found after retries, showing simple modal...');
                        // Simple fallback modal
                        const modal = document.createElement('div');
                        modal.style.cssText = `
                            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                            background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                            justify-content: center; z-index: 10000;
                        `;
                        modal.innerHTML = `
                            <div style="background: #1a1a2e; padding: 20px; border-radius: 10px; color: white; max-width: 400px;">
                                <h3>🔧 デバッグ: 資源販売システム</h3>
                                <p>モジュールが正しく読み込まれていません</p>
                                <button onclick="this.parentElement.parentElement.remove()" style="padding: 10px; margin-top: 10px;">閉じる</button>
                            </div>
                        `;
                        document.body.appendChild(modal);
                    }
                };
                
                tryShowModal();
            });
        } else {
            console.log('🔧 Currency button NOT found');
        }
        
        // Debug: Try to load all systems directly
        setTimeout(() => {
            console.log('🔧 Attempting direct module imports...');
            
            // Load currency system
            import('./dist/js/currencySystem.js')
                .then((currencyModule) => {
                    console.log('🔧 currencySystem module loaded:', currencyModule);
                    if (currencyModule.currencyManager) {
                        window.currencyManager = currencyModule.currencyManager;
                        window.currencyManager.initializeCurrencies();
                        console.log('💰 currencyManager manually set and initialized');
                    }
                })
                .catch((error) => {
                    console.error('🔧 Failed to import currencySystem:', error);
                });
            
            // Load market system
            import('./dist/js/marketSystem.js')
                .then((marketModule) => {
                    console.log('🔧 marketSystem module loaded:', marketModule);
                    if (marketModule.marketSystem) {
                        window.marketSystem = marketModule.marketSystem;
                        window.marketSystem.update();
                        console.log('📈 marketSystem manually set and updated');
                    }
                })
                .catch((error) => {
                    console.error('🔧 Failed to import marketSystem:', error);
                });
            
            // Load modal system
            import('./dist/js/resourceSellModal.js')
                .then((module) => {
                    console.log('🔧 resourceSellModal module loaded:', module);
                    if (module.showResourceSellModal) {
                        window.showResourceSellModal = module.showResourceSellModal;
                        console.log('🔧 showResourceSellModal manually set on window');
                    }
                })
                .catch((error) => {
                    console.error('🔧 Failed to import resourceSellModal:', error);
                });
        }, 2000);
    });
  </script>
  <script>
    // Quick debug: Direct panel test
    document.addEventListener('DOMContentLoaded', () => {
        console.log('🔧 DOM loaded, checking production panel...');
        
        const productionButton = document.getElementById('productionToggleButton');
        const productionPanel = document.getElementById('production-panel');
        
        console.log('🔧 Button:', !!productionButton);
        console.log('🔧 Panel:', !!productionPanel);
        
        if (productionButton && productionPanel) {
            productionButton.addEventListener('click', () => {
                console.log('🔧 Button clicked!');
                productionPanel.classList.toggle('active');
                console.log('🔧 Panel classes:', productionPanel.className);
            });
        }
    });
    
    document.addEventListener('DOMContentLoaded', () => {
        const iconMap = {
            'cosmicDust': 'icon/宇宙の塵.JPG',
            'energy': 'icon/エネルギー.PNG',
            'organicMatter': 'icon/有機物.JPG',
            'biomass': 'icon/バイオマス.JPG',
            'darkMatter': 'icon/ダークマター.JPG',
            'thoughtPoints': 'icon/思考ポイント.JPG',
            'overlayCosmicDust': 'icon/宇宙の塵.JPG',
            'overlayEnergy': 'icon/エネルギー.PNG',
            'overlayDarkMatter': 'icon/ダークマター.JPG',
            'overlayThoughtPoints': 'icon/思考ポイント.JPG'
        };

        for (const [id, src] of Object.entries(iconMap)) {
            const element = document.getElementById(id);
            if (element) {
                const parentP = element.parentElement;
                if (parentP && !parentP.querySelector('.resource-icon')) {
                    const img = document.createElement('img');
                    img.src = src;
                    img.classList.add('resource-icon');
                    // --- スタイルを直接指定 ---
                    const isOverlay = id.startsWith('overlay');
                    img.style.width = isOverlay ? '16px' : '20px';
                    img.style.height = isOverlay ? '16px' : '20px';
                    img.style.marginRight = isOverlay ? '5px' : '8px';
                    img.style.objectFit = 'contain';
                    // -------------------------
                    parentP.prepend(img);
                }
            }
        }
    });

    // Stats/Log Panel Logic
    document.addEventListener('DOMContentLoaded', () => {
      const statsLogContainer = document.getElementById('stats-log-container');
      const toggleIcon = document.getElementById('stats-log-toggle-icon');
      const statsTab = document.getElementById('stats-tab-button');
      const logTab = document.getElementById('log-tab-button');
      const statsPanel = document.getElementById('statistics-panel');
      const logPanel = document.getElementById('timeline-log-panel');

      // Toggle panel visibility
      if (toggleIcon) {
        toggleIcon.addEventListener('click', () => {
          statsLogContainer.classList.toggle('expanded');
          toggleIcon.textContent = statsLogContainer.classList.contains('expanded') ? '▼' : '▲';
        });
      }

      // Switch between tabs
      if (statsTab && logTab && statsPanel && logPanel) {
        statsTab.addEventListener('click', () => {
          statsTab.classList.add('active');
          logTab.classList.remove('active');
          statsPanel.style.display = 'block';
          logPanel.style.display = 'none';
        });

        logTab.addEventListener('click', () => {
          logTab.classList.add('active');
          statsTab.classList.remove('active');
          logPanel.style.display = 'block';
          statsPanel.style.display = 'none';
        });
      }

      // Set initial state
      if (logPanel) {
        logPanel.style.display = 'none';
      }
    });
  </script>
</body>
</html>
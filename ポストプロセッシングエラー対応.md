# Three.js ポストプロセッシングエラー対応について

## 問題の概要
2025年1月28日、Fillstellarで以下のレンダリングエラーが発生しました：

```
TypeError: Cannot read properties of undefined (reading 'value')
    at refreshUniformsCommon (chunk-4SXW5WZW.js?v=d3262f2a:39893:25)
```

このエラーは、Three.jsのポストプロセッシングシェーダーがマテリアルのユニフォーム値にアクセスしようとした際に発生していました。

## 原因
Three.jsの内部処理とカスタムシェーダーパスの間で、ユニフォーム（シェーダー変数）の初期化に不整合が発生していました。特に以下のシェーダーパスで問題が発生：

- ColorCorrectionShader（色補正）
- VignetteShader（ビネット効果）
- GammaCorrectionShader（ガンマ補正）
- FXAAShader（アンチエイリアシング）

## 実施した対応

### 1. 一時的な解決策（現在適用中）
`frontend/js/threeSetup.ts`で問題のあるシェーダーパスをコメントアウトしました：

```typescript
// エラー回避のため一時的に無効化
// composer.addPass(colorCorrectionPass);
// composer.addPass(vignettePass);
// composer.addPass(gammaCorrectionPass);
// composer.addPass(fxaaPass);
```

### 2. 影響
無効化された視覚効果：
- **色補正**: ゲーム全体の色調補正がなくなり、コントラストが低下
- **ビネット効果**: 画面端の暗さがなくなり、没入感が低下
- **ガンマ補正**: 画面の明暗バランスが最適化されない
- **FXAA**: ジャギー（ギザギザ）が目立つようになる

維持されている効果：
- **ブルームエフェクト**: 光の発光効果は正常に動作
- **基本的な3D描画**: ゲームプレイに影響なし

## 今後の対応方針

### 短期的対応
1. Three.jsのバージョンを確認し、シェーダーとの互換性を検証
2. カスタムシェーダーを作成して代替機能を実装
3. エラーハンドリングを強化して、個別のエフェクトの有効/無効を管理

### 長期的対応
1. Three.jsの最新バージョンへのアップグレード
2. ポストプロセッシングライブラリの見直し
3. WebGL2への完全移行を検討

## 開発者向け情報

### エラーを再現したい場合
1. `threeSetup.ts`のコメントアウトを解除
2. ゲームを起動して天体同士を衝突させる
3. コンソールでエラーを確認

### デバッグ方法
`main.ts`に以下のデバッグコードが追加されています：
```typescript
// マテリアルの問題をデバッグ
if (animationCount % 300 === 0) { // 5秒ごとにチェック
    scene.traverse((child) => {
        // マテリアルのユニフォームをチェック
    });
}
```

## ユーザーへの影響
- ゲームプレイには影響なし
- 視覚的な品質が若干低下
- パフォーマンスは向上（処理が軽くなるため）

## 結論
現在の対応は一時的なものですが、ゲームの安定性を優先しました。
今後、より良い解決策を実装する予定です。
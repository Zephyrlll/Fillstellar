# **「Cosmic Gardener」開発・運用環境構築プラン (Rust \+ Amazon Lightsail)**

この資料は、Webゲーム「Cosmic Gardener」のバックエンドをRustで開発し、Amazon Lightsail上で運用するための技術選定、環境構築、およびデプロイ手順をまとめたものです。

## **1\. 全体アーキテクチャ**

システムは、ユーザーのブラウザで動作する「フロントエンド」と、Lightsailサーバー上で動作する「バックエンド」で構成されます。

* **フロントエンド (クライアント):**  
  * **技術:** HTML, CSS, JavaScript (Three.js)  
  * **役割:** ゲームの描画、ユーザー操作の受付を担当。既存のコードをそのまま利用します。  
* **バックエンド (サーバー):**  
  * **技術:** Rust  
  * **役割:** ゲームロジックの計算、データ保存、複数ユーザー間の状態同期など、全ての重要な処理を担当します（サーバーサイド・オーソリティ）。  
* **データベース:**  
  * **技術:** PostgreSQL  
  * **役割:** ユーザーデータ、ゲームの状態などを永続的に保存します。  
* **通信:**  
  * **技術:** WebSocket  
  * **役割:** フロントエンドとバックエンド間のリアルタイムな双方向通信を実現します。

## **2\. 開発環境 (ローカルPC)**

まずはご自身のPC上に、本番環境と似た開発環境を構築します。

* **バックエンド (Rust):**  
  * **言語:** [Rust](https://www.rust-lang.org/ja/tools/install) (rustup経由でインストール)  
  * **Webフレームワーク:** [**Actix Web**](https://actix.rs/) \- 高速で安定しており、実績が豊富なため推奨。  
  * **WebSocketライブラリ:** actix-ws \- Actix Webと親和性が高いです。  
  * **データベース接続:** [**SQLx**](https://github.com/launchbadge/sqlx) \- コンパイル時にSQLをチェックできる、安全性の高いライブラリ。  
* **フロントエンド:**  
  * 既存のHTML/CSS/JSファイル群。  
* **データベース:**  
  * [**PostgreSQL**](https://www.google.com/search?q=https://www.postgresql.jp/docs/current/tutorial-install.html)を直接インストールするか、[Docker](https://www.docker.com/)を使って起動するのが手軽です。

## **3\. 本番環境 (Amazon Lightsail)**

実際にゲームを公開するサーバー環境です。

* **インスタンス (サーバー):**  
  * **サービス:** [Amazon Lightsail](https://aws.amazon.com/jp/lightsail/)  
  * **OS:** **Ubuntu 22.04 LTS** (長期サポート版で安定)  
  * **プラン:** 月額$5のプランから開始し、プレイヤー数に応じてスケールアップを検討。  
* **Webサーバー / リバースプロキシ:**  
  * **ソフトウェア:** **Nginx**  
  * **役割:**  
    1. フロントエンドの静的ファイル（HTML/CSS/JS）を配信。  
    2. WebSocket通信をバックエンドのRustアプリケーションに中継（リバースプロキシ）。  
    3. SSL証明書の管理とHTTPS通信の終端。  
* **バックエンドのデプロイ:**  
  * **ビルド:** 作成したRustコードをサーバー上でコンパイル（ビルド）します。  
  * **永続化:** **systemd** を使い、Rustアプリをサービスとして登録。これにより、サーバーが再起動した際などに自動でアプリが起動するようになります。  
* **データベース:**  
  * Lightsailインスタンス上にPostgreSQLをインストールし、ゲーム専用のデータベースとユーザーを作成します。

## **4\. セキュリティ設定の要点**

安全なサービス運用のための最低限の設定です。

* **Lightsailファイアウォール:**  
  * 公開を許可するポートは以下の3つのみに限定します。  
    * 80 (HTTP): HTTPSへのリダイレクト用  
    * 443 (HTTPS): メインのゲーム通信用  
    * 22 (SSH): あなたがサーバーを管理するためのポート。**必ず自分のIPアドレスからのみ接続を許可する**ように設定します。  
* **OSとソフトウェアの更新:**  
  * 定期的にOS (sudo apt update && sudo apt upgrade) とソフトウェアを最新の状態に保ちます。  
* **SSL証明書の導入:**  
  * [**Let's Encrypt**](https://letsencrypt.org/ja/) を利用し、無料でSSL証明書を導入して通信を暗号化（HTTPS化）します。certbotというツールを使えば簡単に設定できます。

## **5\. 構築・デプロイのステップ概要**

1. **Lightsailインスタンスの作成:** AWSコンソールからUbuntu 22.04のインスタンスを作成します。  
2. **ドメインの設定:** 取得したドメインをLightsailの静的IPアドレスに向けます。  
3. **ツール類のインストール:** SSHでサーバーに接続し、Rust, Nginx, PostgreSQL, Certbotなどをインストールします。  
4. **Rustアプリの配置とビルド:** Git経由でソースコードをサーバーに配置し、cargo build \--releaseで本番用にビルドします。  
5. **systemdの設定:** Rustアプリをサービスとして登録します。  
6. **Nginxの設定:** リバースプロキシと静的ファイル配信の設定を記述します。  
7. **SSL証明書の取得と設定:** certbotを実行し、HTTPS化を完了させます。  
8. **ファイアウォール設定:** Lightsailの管理画面で、上記「セキュリティ設定の要点」の通りに設定します。

このプランに沿って構築を進めることで、Rustのパフォーマンスと安全性を活かした、スケーラブルなゲームサーバー環境をLightsail上に構築できます。